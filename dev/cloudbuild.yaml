steps:  
- id: 'tf init and tf plan'
  name: 'hashicorp/terraform:0.14.9'
  entrypoint: 'sh'
  args: 
  - '-c'
  - |
      if [ $_ENV_TYPE != "PUSH" ]; then
        git clone https://github.com/kyeswanth/solutions-terraform-cloudbuild-gitops.git
        cd solutions-terraform-cloudbuild-gitops
        git checkout $_HEAD_BRANCH
        git diff --quiet $_HEAD_BRANCH remotes/origin/$_BASE_BRANCH -- dev/terraform || echo true > output.log
        if grep -q "true" output.log; then
          echo "inside loop"
          cd dev/terraform
          terraform init
          terraform plan
        fi
      fi

- id: 'tf apply'
  name: 'hashicorp/terraform:0.14.9'
  entrypoint: 'sh'
  args: 
  - '-c'
  - |
      if [ $_ENV_TYPE == "PUSH" ]; then
        cd dev/terraform
        terraform init
        terraform plan
        terraform apply -auto-approve
      fi
